<html>
<head>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <script src="//unpkg.com/mapbox-gl@0.44.2/dist/mapbox-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="//unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="leaflet-mapbox-gl.js"></script>
    <link rel="stylesheet" href="https://cdn.klokantech.com/mapbox-gl-js/v0.43.0/mapbox-gl.css"/>
    <style>
        #mapid {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
    </style>
</head>
<body>
<div id="mapid"></div>
<a href="https://github.com/wadouk/osm-public-transports" style="z-index: 10"><img style="position: absolute; z-index: 1000; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
<script language="JavaScript" type="application/javascript">
  document.addEventListener('DOMContentLoaded', function () {
    var map = L.map('mapid', {
      zoomControl: false
    }).setView([48.8609, 2.3466], 13)

    L.mapboxGL({
      attribution: '' +
      '<a href="http://leafletjs.com" target="_blank">Leaflet</a>' +
      '<a href="http://www.openmaptiles.org/" target="_blank">© OpenMapTiles</a>' +
      ' © <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
      accessToken: 'not-needed',
      style: 'https://free.tilehosting.com/styles/basic/style.json?key=Cib18YVHlgGgsXyYFzPN'
    }).addTo(map)

    const findColor = (p) => p.colour || colorPoint(p)
    function colorPoint (p) {
      let t = (p['@relations'] || []).filter(r => r.reltags.colour).slice(-1)[0]
      return t && t.reltags.colour
    }

    function latlng (coord) {
      return [coord[1], coord[0]]
    }

    const Button = L.Control.extend({
      getContainer: function () {
        const button = document.createElement('button')
        button.innerHTML = this.options.label
        button.addEventListener('click', this.options.click)
        return button
      },

      onAdd: function (map) {
        this._map = map
        return this.getContainer()
      }
    })

    function attr(k, v) {
      const keys = {}
      keys['@id']= (v) => `<a href="https://openstreetmap.org/${v}" target="_blank">${v}</a>`
      keys['@relations'] = (v) => v.map(i => `<a href="https://openstreetmap.org/relation/${i['rel']}" target="_blank">${i.reltags['name']}</a>`).join('<br>')
      return (keys[k] && keys[k](v)) || v
    }

    function dumpProps(o) {
      return o ? Object.entries(o)
        .map((v) => `<b>${v[0]}</b>=${attr(v[0], v[1])}`) : []
    }

    function geojson (file) {
      return () => {
        map.eachLayer(layer => {
          if (layer instanceof L.FeatureGroup) {
            layer.remove()
          }
        })
        fetch(file).then(function (response) {
          response.json().then(blob => {
            L.geoJSON(blob, {
              style: feature => ({color: findColor(feature.properties) || '#31302f'}),
              pointToLayer: feature => L.featureGroup([
                L.circleMarker(L.latLng(latlng(feature.geometry.coordinates)), {
                  color: findColor(feature.properties),
                  fillColor: '#e2e2e2',
                  fill: true,
                  fillOpacity: 1,
                  radius: 5
                }).bindTooltip(feature.properties.name),
              ]),
              onEachFeature: (feature, layer) => {
                layer.bindPopup(dumpProps(feature.properties)
                  .join('<br>'))
              },
              filter: (f) => {
                return f.properties.name
              }
            }).addTo(map)
          })
        })
      }
    }

    new Button({label: 'subway', click: geojson('subway.geojson')}).addTo(map)
    new Button({label: 'tram', click: geojson('tram.geojson')}).addTo(map)
    L.control.zoom({position: 'topright'}).addTo(map)

  })
</script>
</body>
</html>